#!/bin/bash

# =========================================================
# Y86-64 Simulator 自动化构建与测试脚本
# =========================================================

echo "========================================"
echo "STEP 1: 清理并重新编译项目..."
echo "========================================"

# 清理旧文件
make clean

# 编译项目
make

# 检查编译是否成功
if [ $? -ne 0 ]; then
    echo -e "\033[31m[ERROR] 编译失败，请检查代码错误。\033[0m"
    exit 1
fi

echo -e "\033[32m[SUCCESS] 编译成功！\033[0m"

echo "========================================"
echo "STEP 2: 准备测试环境..."
echo "========================================"

# 确保 cpu 可执行
if [ ! -f "./cpu" ]; then
    echo -e "\033[31m[ERROR] 未找到可执行文件 ./cpu\033[0m"
    exit 1
fi
chmod +x ./cpu

# 检查是否存在 answer 目录（比对需要标准答案）
if [ ! -d "./answer" ]; then
    echo -e "\033[33m[WARNING] 未找到 answer 目录，测试可能无法进行比对。\033[0m"
fi

# 检查是否存在 test 目录
if [ ! -d "./test" ]; then
    echo -e "\033[31m[ERROR] 未找到 test 目录，无法加载测试用例。\033[0m"
    exit 1
fi

echo "========================================"
echo "STEP 3: 运行自动化测试脚本 (test.py)..."
echo "========================================"

# 调用你上传的 python 脚本，传入编译好的 ./cpu
# --bin 指定可执行文件路径
python3 test.py --bin ./cpu

# 检查 Python 脚本的退出状态（虽然 test.py 内部可能会捕获异常，但这是一个好习惯）
if [ $? -ne 0 ]; then
    echo -e "\033[31m[ERROR] 测试脚本执行期间发生错误。\033[0m"
    exit 1
fi

echo "========================================"
echo "测试流程结束"
echo "========================================"